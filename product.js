export const PRODUCT_ID_MAP = {
    "workshop": 8246,
    "workshop_trial": 1629,
    "camp_4day": 2063,
    "camp_5day": 924,
    "camp_1day": 2749
  };

const ID_PRODUCT_MAP = {
    8246 : {
        title : "Workshop"
    },
    1629 : {
        title : "Workshop Trial"
    }
}

/** Given a date, return a string representing date w format 'YYYY-mm-ddTHH:I 
 * @param {Date} date - date to be converted
 * @return {string} - converted date in format specified above
*/
function dateToString(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}

/** Mock function to get user bookings */
function getUserBookings(userId=0) {
  return [ 
    { 
      id : 11,
      product_id : 8246,
      customer_id : 123,
      date_start: "2024-06-18T16:30:00",
      date_end: "2024-06-18T18:30:00"
    },
    { 
      id : 12,
      product_id : 8246,
      customer_id : 123,
      date_start: "2024-06-25T16:30:00",
      date_end: "2024-06-25T18:30:00"
    },
    {
      id : 13,
      product_id: 1629,
      customer_id : 123,
      date_start: "2024-06-15T09:00"
    },
    {
      id : 13,
      product_id: 1629,
      customer_id : 123,
      date_start: "2024-06-15T09:00"
    }

  ];
}


/** Given a productID and UserID, return a map from every date with a booking
 * slot of the specified product, mapping to the html components of the buttons 
 * to show in the calendar ui
 * 
 * @param {int} productId - id of product as in site database
 * @param {int} userId - id of current user as in site database
 * 
 * @return {Map<string, Array<string>>} - mapping date string to array of html elements 
 *                                        of time slot options for user and product
 */
export function getDateEventMap(productId, userId=0) {

    // will replace this with a backend call when we get there
    const records = [ { date: '2024-06-10T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-06-11T16:30',
    duration: 2,
    available: 7,
    booked: 1,
    product_id: 8246 },
  { date: '2024-06-15T13:30',
    duration: 2,
    available: 4,
    booked: 4,
    product_id: 8246 },
  { date: '2024-06-17T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-06-18T16:30',
    duration: 2,
    available: 7,
    booked: 1,
    product_id: 8246 },
  { date: '2024-06-22T13:30',
    duration: 2,
    available: 4,
    booked: 4,
    product_id: 8246 },
  { date: '2024-06-24T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-06-25T16:30',
    duration: 2,
    available: 7,
    booked: 1,
    product_id: 8246 },
  { date: '2024-06-29T13:30',
    duration: 2,
    available: 0,
    booked: 8,
    product_id: 8246 },
  { date: '2024-07-01T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-07-02T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-07-06T13:30',
    duration: 0,
    available: 0,
    booked: 8,
    product_id: 8246 },
  { date: '2024-07-08T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-07-09T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-07-13T13:30',
    duration: 2,
    available: 6,
    booked: 2,
    product_id: 8246 },
  { date: '2024-07-15T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-07-16T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-07-20T13:30',
    duration: 2,
    available: 6,
    booked: 2,
    product_id: 8246 },
  { date: '2024-07-22T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-07-23T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-07-27T13:30',
    duration: 2,
    available: 6,
    booked: 2,
    product_id: 8246 },
  { date: '2024-07-29T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-07-30T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-08-03T13:30',
    duration: 2,
    available: 6,
    booked: 2,
    product_id: 8246 },
  { date: '2024-08-05T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-08-06T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-08-10T13:30',
    duration: 2,
    available: 6,
    booked: 2,
    product_id: 8246 },
  { date: '2024-08-12T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-08-13T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-08-17T13:30',
    duration: 2,
    available: 6,
    booked: 2,
    product_id: 8246 },
  { date: '2024-08-19T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-08-20T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-08-24T13:30',
    duration: 2,
    available: 6,
    booked: 2,
    product_id: 8246 },
  { date: '2024-08-26T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-08-27T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-08-31T13:30',
    duration: 2,
    available: 7,
    booked: 1,
    product_id: 8246 },
  { date: '2024-09-02T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-09-03T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-09-07T13:30',
    duration: 2,
    available: 7,
    booked: 1,
    product_id: 8246 },
  { date: '2024-09-09T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-09-10T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-09-14T13:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-09-16T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-09-17T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-09-21T13:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-09-23T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-09-24T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-09-28T13:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-09-30T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-10-01T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-10-05T13:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
  { date: '2024-10-07T16:30',
    duration: 2,
    available: 8,
    booked: 0,
    product_id: 8246 },
    { date: '2024-06-15T09:00',
      duration: 60,
      available: 6,
      booked: 2,
      product_id: 1629 },
    { date: '2024-06-16T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-06-16T13:00',
      duration: 60,
      available: 7,
      booked: 1,
      product_id: 1629 },
    { date: '2024-06-22T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-06-22T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-06-22T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-06-29T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-06-29T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-06-29T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-07-06T10:00',
      duration: 60,
      available: 0,
      booked: 8,
      product_id: 1629 },
    { date: '2024-07-06T11:30',
      duration: 60,
      available: 0,
      booked: 8,
      product_id: 1629 },
    { date: '2024-07-06T13:00',
      duration: 60,
      available: 0,
      booked: 8,
      product_id: 1629 },
    { date: '2024-07-13T10:00',
      duration: 60,
      available: 0,
      booked: 8,
      product_id: 1629 },
    { date: '2024-07-13T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-07-13T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-07-20T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-07-20T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-07-20T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-07-27T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-07-27T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-07-27T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-03T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-03T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-03T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-10T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-10T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-10T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-17T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-17T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-17T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-24T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-24T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-24T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-31T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-31T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-08-31T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-07T09:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-07T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-07T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-07T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-07T17:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-08T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-08T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-08T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-14T09:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-14T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-14T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-14T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-14T17:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-15T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-15T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-15T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-21T09:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-21T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-21T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-21T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-21T17:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-22T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-22T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-22T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-28T09:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-28T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-28T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-28T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-28T17:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-29T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-29T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-09-29T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-10-05T09:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-10-05T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-10-05T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-10-05T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-10-05T17:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-10-06T10:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-10-06T11:30',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 },
    { date: '2024-10-06T13:00',
      duration: 60,
      available: 8,
      booked: 0,
      product_id: 1629 }
];

    // convert records into date -> html map
    // for display next to calendar component
    const now = new Date();
    let dateEventMap = {};

    // get current user bookings to add info to calendar
    const user_bookings = getUserBookings(123);

    
    // get html components for each time slot
    records
    .filter(r => true) //r.product_id === productId)
    .forEach(r => {
        let date = new Date(r.date);
        const mo = date.getMonth();
        const yrs_away = date.getFullYear()-now.getFullYear();
        const dt = date.getDate();

        let totalSlots = r.available + r.booked;
    
        const robj = {
            slot: r,
            date : date,
            html : `
            <button class="event-btn ${r.available>0 ? "available" : ""}" ${r.available===0 ? "disabled" : ""}>
              <span class="slot-indicator"></span>
              <span class="event-content">
                  <h5 class="event-name">${ID_PRODUCT_MAP[r.product_id].title} ${r.available===0 ? "" : `<br><em>(${r.available}/${totalSlots} Available)</em>`}</h5>
                  <p class="event-time">${date.toLocaleString('en-US', {hour: 'numeric', minute: 'numeric', hour12: true})} ${r.available===0?" - FULL":""}</p>
              </span>
            </button>`,
            state : r.available===0?"full":"available"
        }

        // check if curr user booked this slot
        let numBooked = user_bookings
          .filter(b => {
            let d = new Date(b.date_start);
            console.log(1, d);
            console.log(2, date.getTime());
            return d.getTime() == date.getTime();
          })
          .length;
        
        console.log("nb", numBooked);

        if (numBooked > 0) {
          robj.html = `
          <button class="event-btn already-booked">
            <span class="slot-indicator"></span>
            <span class="event-content">
              <h5 class="event-name">${ID_PRODUCT_MAP[r.product_id].title}<br><em>(${r.available}/${totalSlots} Available)</em></h5>
              <p class="event-time">${date.toLocaleString('en-US', {hour: 'numeric', minute: 'numeric', hour12: true})} - Booked (${numBooked})</p>
            </span>
          </button>`;
          robj.state = 'booked';
        }
        
        const monthsFromNow = ((yrs_away*12)+mo) - now.getMonth();
        if (!dateEventMap[monthsFromNow]) {
            dateEventMap[monthsFromNow] = {
                dt : [robj]
            };
        } 
        else if (!dateEventMap[monthsFromNow][dt]) {
            dateEventMap[monthsFromNow][dt] = [robj];
        }
        else {
            dateEventMap[monthsFromNow][dt].push(robj);
        }

    });

    console.log("date event map:",dateEventMap);
    return dateEventMap;
}



